<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Bingo Master - Smart Audio Edition</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" id="theme-color-meta" content="#2563eb">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlByZW1pdW0gQmluZ28gTWFzdGVyIiwKICAic2hvcnRfbmFtZSI6ICJCaW5nbyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAmZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjNlYiIKfQ==">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            transition: background 1.5s ease-in-out;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .theme-morning { background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 55%, #FF99AC 100%); }
        .theme-day { background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%); }
        .theme-evening { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
        .theme-night { background: linear-gradient(135deg, #141e30 0%, #243b55 100%); }

        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }

        .number-ball {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff, #d1d5db);
            color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7rem;
            font-weight: 900;
            box-shadow: inset -15px -15px 30px rgba(0,0,0,0.1), 0 20px 50px rgba(0,0,0,0.4);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .rolling { animation: bounce-roll 0.15s infinite alternate; }
        @keyframes bounce-roll {
            from { transform: scale(1) translateY(0); }
            to { transform: scale(0.95) translateY(-10px); }
        }

        .history-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            font-weight: 700;
            transition: all 0.4s ease;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .history-item.active {
            background: #fff;
            color: #111827;
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
            z-index: 10;
        }

        #visualizer {
            width: 100%;
            height: 60px;
            border-radius: 30px;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
        }

        .flash-active { animation: screen-flash 0.6s ease-out; }
        @keyframes screen-flash {
            0% { background: white; }
            100% { background: transparent; }
        }

        google-cast-launcher {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }

        /* 画面上のお知らせ */
        #notification-overlay {
            position: fixed;
            bottom: 2rem;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 99px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
    </style>
</head>
<body class="theme-day">

    <div id="flash-screen" class="fixed inset-0 pointer-events-none z-[100]"></div>
    <div id="notification-overlay"></div>

    <!-- ツールバー -->
    <div class="fixed top-0 left-0 w-full p-4 flex flex-col sm:flex-row justify-between items-center gap-4 z-50 pointer-events-none">
        <!-- 音響パネル -->
        <div class="glass p-3 rounded-2xl flex flex-col gap-2 w-full sm:w-auto pointer-events-auto">
            <div class="flex items-center justify-between gap-4">
                <span class="text-[10px] uppercase font-bold tracking-widest opacity-70">Hi-Res Auto-Audio</span>
                <input type="file" id="audio-upload" accept="audio/*" class="text-[10px] file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:bg-white file:text-black cursor-pointer">
            </div>
            <canvas id="visualizer"></canvas>
        </div>
        
        <!-- コントロール -->
        <div class="flex items-center gap-2 pointer-events-auto">
            <button id="fs-btn" onclick="toggleFullScreen()" class="glass px-5 py-3 rounded-xl hover:bg-white/20 transition-all flex items-center gap-2">
                <i class="fa-solid fa-expand"></i>
                <span class="text-xs font-bold">全画面</span>
            </button>
            <div class="glass px-4 py-3 rounded-xl flex items-center gap-2">
                <google-cast-launcher></google-cast-launcher>
                <span class="text-xs font-bold">キャスト</span>
            </div>
        </div>
    </div>

    <!-- メイン -->
    <main class="mt-24 sm:mt-32 glass p-10 text-center max-w-lg w-full rounded-[50px] relative z-10 transition-transform duration-500">
        <h1 id="time-greeting" class="text-lg opacity-70 font-medium mb-1 tracking-widest uppercase italic">Bingo</h1>
        <p class="text-5xl font-black mb-12 tracking-tighter italic">PARTY MASTER</p>
        
        <div class="flex justify-center mb-12">
            <div id="display-number" class="number-ball">?</div>
        </div>
        
        <div class="space-y-4">
            <button onclick="drawNumber()" id="draw-btn" class="w-full bg-white text-slate-900 py-6 rounded-3xl font-black text-2xl shadow-xl hover:scale-[1.03] active:scale-[0.97] transition-all flex items-center justify-center gap-4">
                <i class="fa-solid fa-bolt"></i> 抽選
            </button>
            <button onclick="resetBingo()" class="text-white/40 hover:text-white/90 text-sm font-bold transition-all">
                <i class="fa-solid fa-trash mr-2"></i> データを初期化
            </button>
        </div>
    </main>

    <!-- 履歴 -->
    <div class="mt-16 w-full max-w-3xl px-6 pb-20">
        <div class="flex justify-between items-baseline mb-6">
            <h2 class="text-2xl font-black italic tracking-tight opacity-50 uppercase">Number Log</h2>
            <div class="text-white/60 font-mono text-sm">
                COUNT: <span id="draw-count" class="text-white font-bold text-xl">0</span> / 75
            </div>
        </div>
        <div class="grid grid-cols-5 sm:grid-cols-10 gap-3" id="history"></div>
    </div>

    <script>
        let numbers = Array.from({length: 75}, (_, i) => i + 1);
        let history = [];
        const displayEl = document.getElementById('display-number');
        const historyEl = document.getElementById('history');

        function showNote(msg) {
            const el = document.getElementById('notification-overlay');
            el.textContent = msg;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        // --- 安全な全画面表示ロジック ---
        function toggleFullScreen() {
            try {
                if (!document.fullscreenElement) {
                    // 全画面化を試みる
                    const promise = document.documentElement.requestFullscreen();
                    if (promise !== undefined) {
                        promise.catch(err => {
                            console.warn("Fullscreen error:", err);
                            showNote("この環境では全画面表示が制限されています。");
                        });
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            } catch (e) {
                console.error("Fullscreen policy restriction:", e);
                showNote("ブラウザの制限により全画面化できません。");
            }
        }

        // --- ビンゴ抽選 ---
        function initHistory() {
            historyEl.innerHTML = '';
            for (let i = 1; i <= 75; i++) {
                const div = document.createElement('div');
                div.id = `num-${i}`;
                div.className = 'history-item';
                div.textContent = i;
                historyEl.appendChild(div);
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById('draw-count').textContent = history.length;
        }

        function drawNumber() {
            if (numbers.length === 0) return;
            const btn = document.getElementById('draw-btn');
            btn.disabled = true;
            displayEl.classList.add('rolling');
            
            let start = Date.now();
            const roll = () => {
                let elapsed = Date.now() - start;
                displayEl.textContent = Math.floor(Math.random() * 75) + 1;
                if (elapsed < 1200) requestAnimationFrame(roll);
                else {
                    displayEl.classList.remove('rolling');
                    const idx = Math.floor(Math.random() * numbers.length);
                    const result = numbers.splice(idx, 1)[0];
                    displayEl.textContent = result;
                    history.push(result);
                    document.getElementById('flash-screen').classList.add('flash-active');
                    setTimeout(() => document.getElementById('flash-screen').classList.remove('flash-active'), 500);
                    document.getElementById(`num-${result}`).classList.add('active');
                    updateStats();
                    btn.disabled = false;
                }
            };
            requestAnimationFrame(roll);
        }

        function resetBingo() {
            if (!confirm("リセットしますか？")) return;
            numbers = Array.from({length: 75}, (_, i) => i + 1);
            history = [];
            displayEl.textContent = "?";
            initHistory();
        }

        // --- プロフェッショナル音響処理 (AGC & Noise Cancel) ---
        let audioCtx, analyser, dataArray, audioSource, gainNode;
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        document.getElementById('audio-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }

            const buffer = await file.arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(buffer);

            if (audioSource) audioSource.stop();
            audioSource = audioCtx.createBufferSource();
            audioSource.buffer = decoded;
            audioSource.loop = true;

            const notch = audioCtx.createBiquadFilter();
            notch.type = "notch";
            notch.frequency.value = 5000;
            notch.Q.value = 10;

            const shelf = audioCtx.createBiquadFilter();
            shelf.type = "highshelf";
            shelf.frequency.value = 8000;
            shelf.gain.value = 5;

            gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.5;

            const comp = audioCtx.createDynamicsCompressor();
            comp.threshold.setValueAtTime(-24, audioCtx.currentTime);

            audioSource.connect(notch).connect(shelf).connect(gainNode).connect(comp).connect(analyser).connect(audioCtx.destination);
            audioSource.start();
            drawVisualizer();
            autoGainControl();
        });

        function autoGainControl() {
            if (!analyser || !gainNode) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            let target = avg > 0 ? (45 / avg) : 1;
            target = Math.min(Math.max(target, 0.3), 1.8);
            gainNode.gain.setTargetAtTime(target, audioCtx.currentTime, 0.2);
            setTimeout(autoGainControl, 150);
        }

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / dataArray.length) * 2;
            let x = 0;
            for(let i = 0; i < dataArray.length; i++) {
                const barHeight = dataArray[i] / 5;
                ctx.fillStyle = `rgba(255, 255, 255, ${barHeight / 40})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        function updateTheme() {
            const h = new Date().getHours();
            const b = document.body;
            b.className = (h>=5&&h<10)?'theme-morning':(h>=10&&h<17)?'theme-day':(h>=17&&h<20)?'theme-evening':'theme-night';
            document.getElementById('time-greeting').textContent = (h>=5&&h<10)?"Morning":(h>=10&&h<17)?"Afternoon":(h>=17&&h<20)?"Evening":"Night";
        }

        initHistory();
        updateTheme();
        setInterval(updateTheme, 60000);
    </script>
</body>
</html>
